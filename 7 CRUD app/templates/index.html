<html>

<head>
    <title>Todo App</title>
</head>
<style>
    .hidden {
        display: none;
    }

    ul {
        list-style: none;
        padding: 0;
        margin: 0;
        width: 200px;

    }

    li {
        clear: both;
    }

    li button{
        -webkit-appearance: none;
        border: none;
        outline: none;
        color: red;
        float: right;
        cursor: pointer;
        font-size: 20px;
    }
    .list-wrapper, .todos-wrapper{
        display: inline-block;
        vertical-align: top;
    }
</style>

<body>

    <div class="list-wrapper">
        <ul id="lists">
            {% for list in lists %}
            <li>
                <a href='/lists/{{ list.id }}'>
                    {{ list.name }}
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div class="todos-wrapper">
        <h4> {{ active_list.name }}</h4>
        <form id="form">
            <input id="description" type="text" name="description" />
            <input type="submit" value="Create" />
        </form>
    
        <ul id="todos">
            {% for d in todos %}
            <li>
                <input class="check-completed" data-id="{{ d.id }}" type="checkbox" {% if d.completed %} checked {% endif %} /> {{ d.description }}
                <button class="delete-button" data-id="{{ d.id }}">&cross;</button>
            </li>
            {% endfor %}
        </ul>
    
        <div id="error" class="hidden">Something went wrong</div>
    </div>


    <script>
        // delete part of CRUD 
        const deleteitems = document.querySelectorAll(".delete-button");
        for (let i=0; i < deleteitems.length; i++){
            const deleteitem = deleteitems[i];
            deleteitem.onclick = function (e){
                const todoId = e.target.dataset['id'];
                fetch('/stuff/'+todoId+'/deleted', {
                    method: 'DELETE'
                })
                .then(function(){
                    const item =e.target.parentElement;
                    item.remove();
                })
            } 
        }

        // updating part of CRUD 
        const checkboxes = document.querySelectorAll(".check-completed");
        for (let i = 0; i < checkboxes.length; i++) {
            const checkbox = checkboxes[i];
            checkbox.onchange = function (e) {
                const newCompleted = e.target.checked;
                const todoId = e.target.dataset['id'];
                fetch('/stuff/' + todoId + '/set-completed', {
                    method: 'POST',
                    body: JSON.stringify({
                        'completed': newCompleted
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(function() {
                    document.getElementById('error').className='hidden';
                })
                .catch(function() {
                    document.getElementById('error').className='';
                })
            }
        }

        // creating part of CRUD 
        document.getElementById('form').onsubmit = function (e) { //e is an event handler
            e.preventDefault(); //the default method would have refreshed the entire page
            fetch('/stuff/create', {
                method: 'POST',
                body: JSON.stringify({ //sending our post request a body of info when submitted
                    'description': document.getElementById('description').value
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                //this object send the post request over
                //fetch is a promise based library so what it gives back we then..
                .then(function (response) { //then method call back then gives a response
                    return response.json();
                })
                //gets the response back and purse it as json
                //then we will manipulate the json response
                .then(function (jsonResponse) {
                    console.log(jsonResponse); //print out whatever json response we get back.
                    const liItem = document.createElement('LI'); //creating new <li> element tags to hold the data
                    liItem.innerHTML = jsonResponse['description']; //assigning description response to the li innerHtml element
                    document.getElementById('todos').appendChild(liItem); //making the page append the newly created list
                    document.getElementById('error').className = "hidden"; //if there is no issue with the server
                })
                //uses the json response to append a child
                .catch(function () { //gets triggered if someone is wrong with our server
                    document.getElementById('error').className = ''; //removes the class
                })
        }
    </script>
</body>

</html>